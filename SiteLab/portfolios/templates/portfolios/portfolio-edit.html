{% extends 'main/base.html' %}

{% load custom_filters %} 

{% block title %}Edit Portfolio - SiteLab{% endblock %}

{% block content %}

<div class="blob blob-1" style="top: 10%; left: -5%;"></div>
<div class="blob blob-2" style="bottom: 10%; right: -5%;"></div>

<section class="py-5" style="padding-top: 6rem !important; padding-bottom: 2rem !important;">
    <div class="container" data-aos="fade-down">
        <p class="text-start text-primary fw-bold text-uppercase small mb-3">
            <a href="{% url 'main:home' %}" class="text-primary text-decoration-none">Home</a> / 
            <a href="{% url 'portfolios:portfolio_add' %}" class="text-primary text-decoration-none">Templates</a> / 
            <span class="text-dark">Editor</span>
        </p>

        <h1 class="display-5 fw-bolder mb-1">
            <i class="fa-solid fa-paint-brush text-primary me-3"></i> 
            Customize Your <span class="text-gradient">Portfolio</span>
        </h1>
        <p class="lead text-muted small">Template: {{ template_name }} (ID: {{ portfolio.template.id }})</p>
    </div>
</section>

<section class="pb-5">
    <div class="container">
        <div class="row g-4">

            <div class="col-lg-5">
                <div class="card shadow border-0">
                    <div class="card-body p-4">
                        <h4 class="card-title fw-bold mb-4">Content Editor</h4>
                        
                        <form method="post" id="portfolio-form" action="{% url 'portfolios:portfolio_edit' %}">
                            {% csrf_token %}
                            
                            <div class="mb-4">
                                <label for="{{ form.template.id_for_label }}" class="form-label fw-bold">Change Template</label>
                                {{ form.template }}
                                <div class="form-text">Changing the template will reload the editor.</div>
                            </div>
                            
                            <h5 class="fw-bold text-primary border-bottom pb-2 mb-3 mt-4">Personal Details</h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">{{ form.first_name.label }}</label>
                                    {{ form.first_name }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }}</label>
                                    {{ form.last_name }}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.tagline.id_for_label }}" class="form-label">{{ form.tagline.label }}</label>
                                {{ form.tagline }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.about_me.id_for_label }}" class="form-label">{{ form.about_me.label }}</label>
                                {{ form.about_me }}
                            </div>
                            <div class="mb-5">
                                <label for="{{ form.contact_email.id_for_label }}" class="form-label">{{ form.contact_email.label }}</label>
                                {{ form.contact_email }}
                            </div>

                            <h5 class="fw-bold text-primary border-bottom pb-2 mb-3 mt-5">Projects (Up to 3)</h5>
                            
                            {% for i in "123" %}
                                {% with title_name='project'|add:i|add:'_title' %}
                                {% with desc_name='project'|add:i|add:'_description' %}
                                {% with url_name='project'|add:i|add:'_url' %}
                                    {% with project_title_field=form|get_field:title_name %}
                                    {% with project_desc_field=form|get_field:desc_name %}
                                    {% with project_url_field=form|get_field:url_name %}
                                    
                                        <div class="card bg-light p-3 mb-4">
                                            <h6 class="fw-bold mb-3">Project {{ i }}</h6>
                                            
                                            <div class="mb-3">
                                                <label for="{{ project_title_field.id_for_label }}" class="form-label small fw-bold">Title</label>
                                                {{ project_title_field }}
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ project_desc_field.id_for_label }}" class="form-label small fw-bold">Description</label>
                                                {{ project_desc_field }}
                                            </div>
                                            <div class="mb-1">
                                                <label for="{{ project_url_field.id_for_label }}" class="form-label small fw-bold">URL</label>
                                                {{ project_url_field }}
                                            </div>
                                        </div>
                                        
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                {% endwith %}
                                {% endwith %}
                                {% endwith %}
                            {% endfor %}
                        </div>

                        <div class="card-footer bg-white border-0 p-4 pt-3">
                            <div class="d-grid gap-2">
                                <button type="submit" name="save_changes" value="save" class="btn btn-lg btn-secondary w-100 fw-bold">
                                    <i class="fa-solid fa-save me-2"></i> Save Changes
                                </button>
                                <a href="{% url 'portfolios:preview_view' %}" target="_blank" class="btn btn-lg btn-info w-100 fw-bold text-white">
                                    <i class="fa-solid fa-expand me-2"></i> Full Page Preview
                                </a>
                                <button type="submit" name="publish_site" value="publish" class="btn btn-lg btn-primary w-100 fw-bold">
                                    <i class="fa-solid fa-cloud-upload-alt me-2"></i> Publish Portfolio
                                </button>
                            </div>
                            <p class="small text-muted text-center mt-3">Changes auto-save but click Publish to deploy your site.</p>
                        </div>
                    </div>
                </form>
            </div>

            <div class="col-lg-7">
                <div class="preview-wrapper bg-dark rounded-3 p-0 shadow-lg h-100" style="min-height: 800px; overflow: hidden; position: relative;">
                    <iframe id="live-preview" 
                        src="{% url 'portfolios:preview_view' %}" 
                        frameborder="0" 
                        style="width: 100%; height: 100%; border-radius: 6px; display: block;">
                    </iframe>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}


{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('portfolio-form');
        const iframe = document.getElementById('live-preview');
        let saveTimer; 

        const collectFormData = () => {
            const data = {};
            
            form.querySelectorAll('input, textarea, select').forEach(field => {
                if (field.name && field.name !== 'csrfmiddlewaretoken' && field.name !== 'publish_site' && field.name !== 'save_changes') {
                    data[field.name] = field.value || '';
                }
            });

            data['full_name'] = `${data.first_name || ''} ${data.last_name || ''}`.trim();
            
            const projects = [];
            for (let i = 1; i <= 3; i++) {
                const title = data[`project${i}_title`];
                const description = data[`project${i}_description`];
                const url = data[`project${i}_url`];

                if (title && title.trim() !== '') {
                    projects.push({
                        title: title,
                        description: description,
                        url: url
                    });
                }
            }
            data.projects = projects;
            
            return data;
        };

        const updatePreview = () => {
            const data = collectFormData();
            if (iframe.contentWindow) {
                 iframe.contentWindow.postMessage(data, '*');
            }
        };

        const debounceSave = () => {
            clearTimeout(saveTimer);
            
            updatePreview();

            saveTimer = setTimeout(() => {
                const formData = new FormData(form);
                
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                         console.error("Auto-save failed on server.");
                    }
                })
                .catch(error => {
                    console.error("Network error during save:", error);
                });
                
            }, 500);
        };
        
        form.querySelectorAll('input, textarea').forEach(field => {
            field.addEventListener('input', () => {
                debounceSave();
            });
        });
        
        document.querySelector('select[name="template"]').addEventListener('change', function() {
            window.location.href = "{% url 'portfolios:portfolio_edit' %}?template_id=" + this.value;
        });

        iframe.addEventListener('load', function() {
            updatePreview();
        });
        
        updatePreview();
    });
</script>
{% endblock %}